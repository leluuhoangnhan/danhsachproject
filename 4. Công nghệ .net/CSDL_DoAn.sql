CREATE DATABASE DB_QLDA ON PRIMARY
(
	NAME=QLCSDL_DOAN,
	FILENAME='F:\QLCSDL_DOAN\FILE_CHINH.MDF',
	SIZE=10,
	MAXSIZE=1000,
	FILEGROWTH=10%
),
(
	NAME=QLCSDL_DOAN_P1,
	FILENAME='F:\QLCSDL_DOAN\FILE_PHU1.NDF',
	SIZE=2,
	MAXSIZE=200,
	FILEGROWTH=10%
)
LOG ON
(
	NAME=QLCSDL_DOAN_LOG,
	FILENAME='F:\QLCSDL_DOAN\FILE_LOG.LDF',
	SIZE=3,
	MAXSIZE=250,
	FILEGROWTH=10%
)

GO
USE DB_QLDA

USE master
DROP DATABASE DB_QLDA

GO
CREATE TABLE CHUDAUTU
(
	MACDT VARCHAR(30) NOT NULL,
	TENCDT NVARCHAR(50),
	NGAY_DKKD DATE,
	MASOTHUE VARCHAR(30) NOT NULL,
	MADUAN VARCHAR(30) NOT NULL,
	IMG VARCHAR(300) DEFAULT ('LeLuuHoangNhan.jpg')
	CONSTRAINT PK_MACDT_MASOTHUE_MADUAN PRIMARY KEY(MACDT, MASOTHUE,MADUAN)
)


GO
CREATE TABLE KHACHHANG
(
	MAKH VARCHAR(30) NOT NULL,
	HOTEN NVARCHAR(50),
	NGAYSINH DATE,
	GTINH NVARCHAR(10),
	NGAYMUA_THUE DATE,
	MADUAN VARCHAR(30) NOT NULL,
	CONSTRAINT PK_MAKH_MADUAN PRIMARY KEY(MAKH,MADUAN)
)


GO
CREATE TABLE THUE
(
	MASOTHUE VARCHAR(30) NOT NULL,
	TENTHUE NVARCHAR(50),
	LOAITHUE NVARCHAR(50),
	CONSTRAINT PK_MASOTHUE PRIMARY KEY(MASOTHUE)
)

GO
CREATE TABLE DUAN
(
	MADUAN VARCHAR(30) NOT NULL,
	TENDUAN NVARCHAR(50),
	DIACHI NVARCHAR(50),
	NAMBG INT,
	MAKD VARCHAR(30),
	CONSTRAINT PK_MADUAN PRIMARY KEY(MADUAN)
)

GO
ALTER TABLE DUAN
ADD SOLUONG_KH INT DEFAULT 0
GO
ALTER TABLE DUAN
ADD SOLUONG_CDT INT DEFAULT 0


GO
CREATE TABLE KHUDAT
(
	MAKD VARCHAR(30) NOT NULL,
	CHUSOHUU NVARCHAR(50),
	MADUAN VARCHAR(30),
	CONSTRAINT PK_MAKD PRIMARY KEY(MAKD)
)


------------ĐĂNG NHẬP/ĐĂNG KÝ-----PHÂN QUYỀN-----------
GO
CREATE TABLE TAIKHOAN
(
	TEN VARCHAR(30) NOT NULL,
	PASS VARCHAR(50),
	LOAI NVARCHAR(50) NOT NULL,
	CONSTRAINT PK_FULL_TK PRIMARY KEY(TEN,LOAI)
)

GO
CREATE TABLE SAVE_DANGNHAP
(
	TEN VARCHAR(30) NOT NULL,
	PASS VARCHAR(50),
	LOAI NVARCHAR(50) NOT NULL,
	CONSTRAINT PK_TEN_SAVE PRIMARY KEY(TEN,LOAI)
)

GO
ALTER TABLE SAVE_DANGNHAP
ADD CONSTRAINT FK_FULL_DN FOREIGN KEY(TEN,LOAI) REFERENCES TAIKHOAN(TEN,LOAI)



DROP TABLE SAVE_DANGNHAP
DROP TABLE TAIKHOAN




---------------------------------------------------------

---------------------BẢNG LƯU DANH SÁCH NHÓM----------DANH SÁCH CÁC TABLE MẶC ĐỊNH--------------
GO
CREATE TABLE DS_TABLE
(
	TEN_TABLE NVARCHAR(50) NOT NULL,
	CONSTRAINT PK_TEN_TABLE PRIMARY KEY(TEN_TABLE)
)

GO
CREATE TABLE DS_NHOM
(
	TENNHOM NVARCHAR(50) NOT NULL,
	CONSTRAINT PK_TENNHOM PRIMARY KEY(TENNHOM)
)

-- 5 NHÓM MẶC ĐỊNH
GO
INSERT INTO DS_NHOM
VALUES('Thong_thuong'),
		('Trung_cap'),
		('Vip'),
		('Super_Vip'),
		('Quan_tri')


-- 5 BẢNG MẶC ĐỊNH
INSERT INTO DS_TABLE
VALUES('CHUDAUTU'),
		('DUAN'),
		('KHACHHANG'),
		('KHUDAT'),
		('THUE')


---------------------------------------------------------

---------------------BẢNG LƯU DANH SÁCH QUYỀN ĐƯỢC THỰC THI TRÊN CÁC USER VÀ NHÓM QUYỀN--------------
GO
CREATE TABLE PHANQUYEN
(
	TEN NVARCHAR(50) NOT NULL,
	QUYEN VARCHAR(50) NOT NULL,
	BANG_CHON VARCHAR(50) NOT NULL,
	CONSTRAINT PK_FULL_KEY PRIMARY KEY(TEN,QUYEN,BANG_CHON)
)



---------------------------------------------------------



GO
ALTER TABLE CHUDAUTU
ADD CONSTRAINT FK_MASOTHUE_CDT FOREIGN KEY(MASOTHUE) REFERENCES THUE(MASOTHUE)

ALTER TABLE CHUDAUTU
ADD CONSTRAINT FK_MADUAN_CDT FOREIGN KEY(MADUAN) REFERENCES DUAN(MADUAN)

ALTER TABLE KHACHHANG
ADD CONSTRAINT FK_MADUAN_KH FOREIGN KEY(MADUAN) REFERENCES DUAN(MADUAN)

ALTER TABLE DUAN
ADD CONSTRAINT FK_MAKD_KHUDAT FOREIGN KEY(MAKD) REFERENCES KHUDAT(MAKD)

ALTER TABLE KHUDAT
ADD CONSTRAINT FK_MADUAN_KD FOREIGN KEY(MADUAN) REFERENCES DUAN(MADUAN)

-------------------------------------INSERT INTO--------------------------
GO
INSERT INTO THUE
VALUES('T001',N'THUẾ CÔNG CHỨNG TRƯỚC BẠ',N'BẮT BUỘC'),
	('T002',N'THUẾ GTGT',N'BẮT BUỘC'),
	('T003',N'THUẾ BVMT',N'KHÔNG BẮT BUỘC'),
	('T004',N'THUẾ TNCN',N'KHÔNG BẮT BUỘC'),
	('T005',N'THUẾ DKKD',N'BẮT BUỘC')

select * from THUE
delete from THUE


GO
INSERT INTO DUAN(MADUAN,TENDUAN,DIACHI,NAMBG)
VALUES('DA001','FELIZ EN VISTA','01 PHAN VĂN ĐÁNG',2020),
	('DA002','VISTA VERDE','02 PHAN VĂN ĐÁNG',2018),
	('DA003','ONE VERANDAH','BÁT NÀN - THẠNH MỸ LỢI',2020),
	('DA004','THE CBD','125 ĐỒNG VĂN CỐNG',2013),
	('DA005','LA ASTORIA','383 NGUYỄN DUY TRINH',2019),
	('DA006','PARCSPRING','543 NGUYỄN DUY TRINH',2016),
	('DA007','THE KRISTA','547 NGUYỄN DUY TRINH',2018)



GO
INSERT INTO KHUDAT
VALUES('KD001','NGUYỄN VĂN A','DA001'),
	('KD002','NGUYỄN VĂN A','DA002'),
	('KD003','NGUYỄN VĂN B','DA003'),
	('KD004','NGUYỄN VĂN B','DA004'),
	('KD005','NGUYỄN VĂN C','DA005')


GO
UPDATE DUAN
SET MAKD=(SELECT MAKD
		FROM KHUDAT
		WHERE MADUAN=DUAN.MADUAN)


GO
SET DATEFORMAT DMY
INSERT INTO CHUDAUTU (MACDT,TENCDT,NGAY_DKKD,MASOTHUE,MADUAN, IMG)
VALUES('CDT001',N'CAPITALAND','01/03/2001','T001','DA001','Capitaland.png'),
	('CDT002',N'KHANG ĐIỀN','04/09/1996','T001','DA002','Khangdien.png'),
	('CDT003',N'AN GIA HƯNG','08/12/2001','T002','DA003', 'AnGiaHung.png'),
	('CDT004',N'THỊNH VƯỢNG','09/07/2010','T003','DA004', 'HongKongLand.png'),
	('CDT005',N'PHƯỚC THÀNH','10/05/1996','T002','DA005', 'PhuocThanh.jpg')


GO
SET DATEFORMAT DMY
INSERT INTO KHACHHANG
VALUES('KH001',N'LÊ A','01/03/2001',N'NAM','31/05/2020','DA001'),
	('KH002',N'LÊ B','08/01/2000',N'NỮ','20/04/2016','DA002'),
	('KH003',N'LÊ C','28/03/2001',N'NỮ','31/05/2020','DA001'),
	('KH004',N'LÊ R','20/11/1996',N'NAM','20/02/2015','DA004'),
	('KH005',N'LÊ G','05/09/1985',N'NỮ','16/07/2010','DA005'),
	('KH002',N'LÊ B','08/01/2000',N'NỮ','20/04/2016','DA003'),
	('KH001',N'LÊ A','01/03/2001',N'NAM','31/05/2020','DA002')


GO
UPDATE DUAN
SET SOLUONG_KH = (SELECT COUNT(MAKH) FROM KHACHHANG KH, DUAN DA WHERE KH.MADUAN=DA.MADUAN AND KH.MADUAN=DUAN.MADUAN)
GO
UPDATE DUAN
SET SOLUONG_CDT = (SELECT COUNT(MACDT) FROM CHUDAUTU CDT, DUAN DA WHERE CDT.MADUAN=DA.MADUAN AND DA.MADUAN=DUAN.MADUAN)







--------------------------------------- ĐỒ ÁN CÔNG NGHỆ .NET --------------------------------------

--FROM CHUDAUTU: HÀM TRẢ VỀ SỐ LƯỢNG DỰ ÁN CDT ĐÃ THAM GIA, THAM SỐ TRUYỀN VÀO LÀ MACDT (SỬ DỤNG CURSOR)
GO
CREATE FUNCTION HAM_DEM_SL_DUAN_CDT (@MACDT VARCHAR(50))
RETURNS INT
AS
BEGIN
	DECLARE CS_DEM_SOLUONG_DUAN CURSOR SCROLL DYNAMIC
	FOR SELECT DISTINCT MADUAN FROM CHUDAUTU WHERE MACDT=@MACDT
	OPEN CS_DEM_SOLUONG_DUAN

	DECLARE @MADUAN VARCHAR(50), @DEM INT=0
	FETCH NEXT FROM CS_DEM_SOLUONG_DUAN INTO @MADUAN 
	WHILE (@@FETCH_STATUS=0)
	BEGIN
		SET @DEM+=1
		FETCH NEXT FROM CS_DEM_SOLUONG_DUAN INTO @MADUAN 
	END

	CLOSE CS_DEM_SOLUONG_DUAN
	DEALLOCATE CS_DEM_SOLUONG_DUAN

	RETURN @DEM
END

GO
DECLARE @SL INT =  DBO.HAM_DEM_SL_DUAN_CDT('CDT001')
PRINT @SL



--FROM CHUDAUTU: TÍNH THỜI GIAN THÀNH LẬP DOANH NGHIỆP CỦA CDT CHO ĐẾN NAY
GO
CREATE FUNCTION HAM_TINH_THOIGIANTHANHLAPCDT (@MACDT VARCHAR(50))
RETURNS INT
AS
BEGIN
	DECLARE @MONTH INT
	SELECT @MONTH = DATEDIFF(MONTH,NGAY_DKKD,GETDATE()) FROM CHUDAUTU WHERE MACDT = @MACDT

	RETURN @MONTH
END

GO
DECLARE @MONTH INT =  DBO.HAM_TINH_THOIGIANTHANHLAPCDT('CDT001')
PRINT @MONTH


--FROM DUAN: KHI CẬP NHẬT THÔNG TIN BÊN TABLE KHACHHANG THÌ TỰ ĐỘNG CẬP NHẬT SOLUONG_KH BÊN TABLE DUAN
GO
CREATE TRIGGER TRG_UPDATE_SL_KH ON KHACHHANG
FOR UPDATE
AS
BEGIN
	BEGIN TRAN
		BEGIN TRAN
			SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

			UPDATE DUAN
			SET SOLUONG_KH=(SELECT COUNT(*) FROM KHACHHANG WHERE MADUAN= (SELECT MADUAN FROM deleted))
			WHERE DUAN.MADUAN=(SELECT MADUAN FROM deleted)
				
			SELECT * FROM DUAN WHERE MADUAN= (SELECT MADUAN FROM deleted) OR MADUAN= (SELECT MADUAN FROM inserted)
		COMMIT TRAN


		BEGIN TRAN
			SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

			UPDATE DUAN
			SET SOLUONG_KH=(SELECT COUNT(*) FROM KHACHHANG WHERE MADUAN= (SELECT MADUAN FROM inserted))
			WHERE DUAN.MADUAN=(SELECT MADUAN FROM inserted)
	
			SELECT * FROM DUAN WHERE MADUAN= (SELECT MADUAN FROM deleted) OR MADUAN= (SELECT MADUAN FROM inserted)
		COMMIT TRAN


	COMMIT TRAN
END

DROP TRIGGER TRG_UPDATE_SL_KH

GO
UPDATE KHACHHANG
SET MADUAN='DA002'
WHERE MAKH='KH003'


--FROM DUAN: KHI UPDATE DỮ LIỆU TRONG TABLE CHUDAUTU THÌ  UPDATE LẠI SOLUONG_CDT TRÊN TABLE DUAN
GO
CREATE TRIGGER TRG_SELECT_CHUDAUTU ON CHUDAUTU
FOR UPDATE
AS
BEGIN	
	BEGIN TRAN
		UPDATE DUAN
		SET SOLUONG_CDT = (SELECT COUNT(MACDT) FROM CHUDAUTU CDT, DUAN DA WHERE CDT.MADUAN=DA.MADUAN AND DA.MADUAN=(SELECT MADUAN FROM deleted))
		WHERE DUAN.MADUAN=(SELECT MADUAN FROM deleted)

		UPDATE DUAN
		SET SOLUONG_CDT = (SELECT COUNT(MACDT) FROM CHUDAUTU CDT, DUAN DA WHERE CDT.MADUAN=DA.MADUAN AND DA.MADUAN=(SELECT MADUAN FROM inserted))
		WHERE DUAN.MADUAN=(SELECT MADUAN FROM inserted)
	COMMIT TRAN	
END

DROP TRIGGER TRG_SELECT_CHUDAUTU

GO
UPDATE CHUDAUTU
SET MADUAN='DA003'
WHERE MACDT='CDT001'


------ CHỨC NĂNG: Sao lưu, phục hồi trên ứng dụng cho phép người dùng có thể thực hiện.
GO
ALTER DATABASE DB_QLDA
SET RECOVERY FULL

--Sao Lưu
GO
CREATE PROC TT_BACKUP
AS
BEGIN
	BACKUP DATABASE DB_QLDA TO DISK='F:\QLCSDL_DOAN\FULL_BACKUP.BAK' WITH INIT
END

GO
EXEC DBO.TT_BACKUP


--Khôi phục
GO
CREATE PROC TT_RESTORE
AS
BEGIN
	ALTER DATABASE DB_QLDA
	SET OFFLINE WITH ROLLBACK IMMEDIATE

	RESTORE DATABASE DB_QLDA FROM DISK='F:\QLCSDL_DOAN\FULL_BACKUP.BAK' WITH REPLACE, RECOVERY

	ALTER DATABASE DB_QLDA
	SET ONLINE
END

GO
USE master
EXEC DBO.TT_RESTORE


-----Đếm số lượng khách hàng
GO
CREATE FUNCTION HAM_DEMSO_KH()
RETURNS INT
AS
BEGIN
	DECLARE @TAM INT=(SELECT COUNT(DISTINCT MAKH) FROM KHACHHANG)
	RETURN @TAM
END

DECLARE @SL INT=DBO.HAM_DEMSO_KH()
PRINT @SL


------Khách hàng giao dịch nhiều nhất
GO
SELECT * FROM KHACHHANG

GO
CREATE FUNCTION HAM_LAY_MAKH_GIAODICH_MAX()
RETURNS VARCHAR(50)
AS
BEGIN
	DECLARE @MAKH VARCHAR(50)=(SELECT TOP 1 MAKH FROM KHACHHANG GROUP BY(MAKH) ORDER BY COUNT(MAKH) DESC)
	RETURN @MAKH
END

DECLARE @MAKH VARCHAR(50)=DBO.HAM_LAY_MAKH_GIAODICH_MAX()
PRINT @MAKH


------Dự án được KH giao dịch nhiều nhất
GO
SELECT * FROM KHACHHANG
SELECT * FROM DUAN

GO
CREATE FUNCTION HAM_LAY_TENDA_GIAODICH_MAX()
RETURNS NVARCHAR(50)
AS
BEGIN
	DECLARE @TENDA NVARCHAR(50)=(SELECT TENDUAN FROM DUAN WHERE MADUAN=(SELECT TOP 1 MADUAN FROM KHACHHANG GROUP BY(MADUAN) ORDER BY COUNT(MADUAN) DESC))
	RETURN @TENDA
END

DECLARE @TENDA NVARCHAR(50)=DBO.HAM_LAY_TENDA_GIAODICH_MAX()
PRINT @TENDA


------THÊM TÀI KHOẢN ADMIN VÀO BẢNG TÀI KHOẢN
GO
INSERT INTO TAIKHOAN
VALUES('nhan','123','Quan_tri')


SELECT * FROM TAIKHOAN
SELECT * FROM SAVE_DANGNHAP
SELECT * FROM PHANQUYEN

DELETE FROM TAIKHOAN
DELETE FROM SAVE_DANGNHAP
DELETE FROM PHANQUYEN




-----------------------------@BẢN QUYỀN THUỘC LÊ LƯU HOÀNG NHÂN (ĐỒ ÁN CẢ NHÓM CÔNG NGHỆ . NET)---------------------------------
